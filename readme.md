# 软件功能

该软件可用于修改高精度地图文件（xodr）的数据内容，包括道路宽度、坡度与形状，并支持同时修改对应的测试信息文件（json）。

软件有命令行交互、自然语言交互、脚本读取三种格式，可以支持批量操作。

# 命令序列生成基本规则
在自然语言交互模式中，助手需要将自然语言翻译为命令序列。命令的格式必须严格遵循规范，不得添加无关部分。
命令序列中，每个命令独占一行，以一行文件名开头，表示打开目标文件，并最终以一行close结尾，表示关闭文件。

# 命令格式定义
非必须输入的参数均有默认值，且可以省略。必须输入的参数标注为*。

id均不可省略，可以取为random_x_y，表示随机取测试范围内的道路，x代表测试场景考虑的ego车辆行驶路线数量，y代表是否考虑npc车辆。

部分参数可指定为random_x_y，表示取xy之间的随机值，它们标注为+。

## width 命令
width命令是编辑命令，用于修改指定道路部分或全部车道的宽度，并可通过广度优先搜索批量修改其它连接道路的宽度。

width命令包含以下参数：
1. **id***：修改的道路id号，不可省略。
2. **v***+: 输入值，不可省略。
3. **s**: 是否平滑与其它道路连接边缘，默认为0。
4. **ms**: 广度优先搜索层数，默认为0。
5. **sh**: 仅在同向道路上搜索，默认为0。
6. **li**: 车道信息，默认为空，即修改所有车道段的所有车道。示例：li=-1,1,2

*注：id为random时，li无意义，车道也会随机选取。*
*注：由于数据集中所有道路仅含一个车道段，默认修改第一个车道段。*
*注：同时修改多条车道时，增加/减少的宽度为道路的总宽度，而非单个车道的宽度。*

## slope 命令
slope命令是编辑命令，用于修改指定道路的坡度，并可通过广度优先搜索批量修改其它连接道路的高度。

slope命令包含以下参数：
1. **id***：修改的道路id号，不可省略。
2. **v***+: 输入值，不可省略。
3. **m**: 修改模式，分为add加法和mul乘法，默认为mul（修改坡度）。
4. **mv***: 改变道路指定端高度。0表示尾部，1表示头部，2表示首尾同时改变。
5. **ms**: 广度优先搜索层数，默认为0。
6. **sh**: 仅在同向道路上搜索，默认为0。

## fit 命令
fit命令是编辑命令，在道路上采样途径点，并用最小二乘法来将整条道路拟合为数段三阶贝塞尔曲线，以供curve命令修改。
1. **id***：修改的道路id号，必须输入，可以为random，表示任取测试范围内的一条道路。
2. **md**+：可以容忍的最大误差比例（拟合点和真实点的距离与起点到终点距离的比值），默认为0.01（1%）。
3. **st**+：采样途径点的间隔，默认为1.0，即每隔一米采样一个点。

*注：命令运行结束时会返回拟合的曲线段数，并回显道路形状。*

## curve 命令
curve命令是编辑命令，用于修改指定道路的形状。命令用于编辑一段指定的三阶贝塞尔曲线，该曲线有两个控制点L0和L1，通过改变控制点以及起点、终点的位置对曲线的形状进行修改。

设曲线起点O0到终点O1的距离为L，
点L0在以曲线起点O0为原点的极坐标系中坐标为(p0, l0)，修改后，L0的坐标为（p0+h0, l0+L*v0）。
点L1在以曲线终点O1为原点的极坐标系中坐标为(p1, l1)，修改后，L1的坐标为（p1+h1, l1+L*v1）。
x0 y0和x1 y1分别表示曲线起点和终点的位移。

*注：若修改中间段的三次曲线，相邻的曲线段会被同时编辑以确保曲线整体的平滑。*
*注：过高的v值与h值会使道路形状剧烈畸变，一般来讲是无意义的。*
*注：若gi输入random，则会在curve命令前默认运行一个fit命令（不需要显式指明），并在拟合后的曲线中任选一段。*

1. **id***：修改的道路id号，必须输入，可以为random，表示任取测试范围内的一条道路。
2. **x0**+: 参数。
3. **y0**+: 参数。
4. **h0**+: 参数。
5. **v0**+: 参数。
6. **x1**+: 参数。
7. **y1**+: 参数。
8. **h1**+: 参数。
9. **v1**+: 参数。
10. **gi**: 修改的geomotry编号，默认为0。


## lane 命令
lane命令是编辑命令。

lane命令包含以下参数：
1. **id***：修改的道路id号，不可省略。
2. **li***: 车道id号，不可省略。
3. **info**: 元素参数，格式为info=参数名1:参数值1,参数名2:参数值2。参数量不限。示例：info=type:driving,level:false。

## object 命令
object命令是编辑命令。

object命令包含以下参数：
1. **id***：修改的道路id号，不可省略。
2. **oi***: 物体id号，不可省略。
3. **name***: 物体名，不可省略。
4. **info**: 元素参数，格式为info=参数名1:参数值1,参数名2:参数值2。参数量不限。示例：info=s:0,t:0。

## signal 命令
signal命令是编辑命令。

signal命令包含以下参数：
1. **id***：修改的道路id号，不可省略。
2. **si***: 标志id号，不可省略。
3. **info**: 元素参数，格式为info=参数名1:参数值1,参数名2:参数值2。参数量不限。示例：info=s:0,t:0。

## close 命令

关闭文件。

## undo 命令

撤销上一条编辑指令的编辑效果。

## saveName 命令

设置存储的文件名。

# 命令序列示例

ARG_Carcarana-1_1_I-1-1\
savename test0\
curve id=random v0=random_-0.5_0.5 v1=random_-0.5_0.5\
undo\
savename test1\
curve id=random v0=random_-0.5_0.5 v1=random_-0.5_0.5\
undo\
savename test2\
curve id=random v0=random_-0.5_0.5 v1=random_-0.5_0.5\
close

它表示将ARG_Carcarana-1_1_I-1-1随机编辑为test0, test1, test2三个新地图。